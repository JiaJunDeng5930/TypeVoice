# TypeVoice 性能验证计划（Perf Spike）

目标：在进入功能开发前，用可复现的数据验证本地 ASR 在 RTX 4060 Laptop 环境是否达成“非常顺畅”的速度要求，并为后续优化路径提供决策依据。

## 1. 验证范围

- 本地部分：FFmpeg 预处理 + ASR 转录（PyTorch CUDA）。
- 不包含：LLM 改写网络耗时（需单独统计展示，但不计入本地是否达标）。

## 2. 核心指标

- RTF = ASR 转录耗时 / 音频时长。
- 总耗时：预处理耗时 + 转录耗时。
- 资源指标：GPU 显存峰值、GPU 利用率、CPU 利用率、常驻内存。

## 3. 通过标准（与基础规格一致）

必须达标：

- 60 秒音频：RTF <= 0.30
- 5 分钟音频：RTF <= 0.35

目标：

- 60 秒音频：RTF <= 0.20
- 5 分钟音频：RTF <= 0.25

## 4. 测试样本集（建议最小集合）

每条样本需记录：来源、采样率、时长、内容类型。

- A：10 秒，中文短句，含少量停顿
- B：60 秒，中文段落，口语表达，含数字
- C：5 分钟，中文连续表达，含停顿与自我修正

备注：样本音频内容不需要入库到历史记录，样本仅用于开发阶段性能测试。

本机样本文件约定与来源见：`docs/fixtures-sources.md`（音频文件放在本机 `fixtures/`，不提交到 git）。

## 5. 预处理口径（冻结建议）

- 使用内置 FFmpeg 统一输出为 ASR 输入格式（建议 WAV/PCM 16kHz/mono）。
- 预处理参数固定后不得随意改动，避免造成“指标漂移”。

## 6. ASR 参数口径（待冻结）

需要在 Spike 中记录以下参数并固定：

- `device`：cuda 或 cpu
- dtype：fp16 或 fp32（优先 fp16）
- 解码策略相关参数（beam、温度、chunk 大小等）

Spike 的输出需要包含“参数快照”，用于未来复现。

## 7. 失败与诊断记录

若未通过标准，需要记录至少一条明确原因并提出下一步：

- 实际在 CPU 运行（CUDA 不可用或 fallback）
- dtype 未启用 fp16
- IO/预处理成为瓶颈（转码过慢、读写盘过慢）
- 解码参数过于保守导致速度下降

## 8. 决策输出

Spike 完成后必须给出：

- 是否满足“必须达标”与“目标”。
- 主要瓶颈点。
- 优化路径建议（按收益排序），例如：
- fp16/amp 与 torch.compile
- 分段推理策略（避免长音频 padding）
- ONNXRuntime CUDA 或 TensorRT 的备选路线（仅作为备选，不改变当前冻结的 PyTorch CUDA 选择，除非必须）
