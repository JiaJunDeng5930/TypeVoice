# TypeVoice 基础规格 v0.1（冻结中）

状态：冻结中（除“待确认/待验证”章节外，其余为冻结约束）

面向平台：Windows 桌面端（MVP 仅 Windows；iOS/Linus 未来扩展不在本版本范围内）

交互形态：录完再出稿（非流式）

## 1. 产品目标

- 提供一个稳定、快速、隐私友好的中文语音打字流程：录音结束后在本地完成 ASR 转录，再将文本发送到 LLM API 做纠错与表达澄清，最后一键复制给用户粘贴使用。
- MVP 优先解决：可用性、稳定性、速度、可取消、可观测（阶段与耗时可见）。

## 2. 术语

- ASR：Automatic Speech Recognition，自动语音识别。
- LLM：Large Language Model，大语言模型。
- RTF：Real-Time Factor，本地转录耗时 / 音频时长。

## 3. 业务需求（Functional）

### 3.1 核心流程（MVP）

1. 用户点击开始录音。
2. 用户点击结束录音。
3. 应用使用内置 FFmpeg 对音频进行预处理，产出 ASR 友好输入格式。
4. 应用使用本地 ASR 模型进行转录，得到带标点与分割的文本（以模型能力为准）。
5. 可选：将 ASR 文本发送到 LLM API 进行改写。
6. 展示结果与耗时摘要，支持一键复制最终文本。

### 3.2 必须功能（MVP）

- 录音控制
- 开始录音
- 结束录音
- 取消任务（任何阶段可取消）
- 阶段与状态展示
- 阶段：录音中、预处理中、转录中、改写中、完成、失败、已取消
- 显示每阶段耗时与总耗时
- 本地 ASR（冻结选择）
- 模型：`Qwen/Qwen3-ASR-0.6B`
- 推理后端：PyTorch CUDA（强制；不允许 CPU 降级）
- 模型管理（冻结选择）
- 应用内下载模型
- 下载完成后做校验（校验项见 `docs/tech-spec-v0.1.md`）
- 支持查看当前模型版本与存储路径
- LLM 改写（冻结选择）
- LLM 通过 API 调用
- API 仅发送文本，不发送音频
- LLM 相关配置必须可在 UI 中设置（不要求改源码/环境变量）
- 可配置项：API Base URL、API Key、LLM Model、推理等级（reasoning_effort）
- LLM 失败时必须保留 ASR 原文并允许用户复制原文
- 提示词模板（冻结选择）
- 提示词/模板可在 UI 内便捷编辑，不需要改源代码
- 模板至少支持“编辑并立即生效 + 导入/导出 JSON”（MVP 不强制完整 CRUD）
- 支持导入/导出模板（推荐 JSON）
- 默认内置模板至少包含两类
- 纠错：纠正错字、标点、断句、术语统一，尽量不改变原意
- 表达澄清：对表达不清、指代不明处更清晰表述，但不得编造事实
- 结果展示与导出（冻结选择）
- 展示 ASR 原文与 LLM 改写后的最终文本
- 最终文本支持用户手动编辑
- 一键复制最终文本到剪贴板
- 历史记录（冻结选择）
- 仅保存文本与元信息
- 不保存音频

### 3.3 明确不做（MVP Out of Scope）

- 边说边出字（流式转录）
- 说话人分离与 diarization
- 端上离线 LLM 改写
- 自动输入（模拟键盘输入）与全局热键与托盘常驻（属于后续需求，需在架构上预留）

### 3.4 后续需求（不进 MVP，但需要预留接口）

- 全局热键
- 托盘常驻
- 自动输入（仅作为未来扩展；本版本只复制）

## 4. 质量保证（Quality / Reliability / Security）

### 4.1 稳定性与正确性（MVP 验收）

- 任务必须终止于可解释状态
- 成功：产出 ASR 文本；若启用 LLM，则产出改写文本或给出改写失败原因并保留 ASR 原文
- 失败：必须展示清晰错误原因与建议动作
- 取消：必须在 UI 上即时生效，并确保后端计算停止与资源释放
- 稳定性轻压测：`full` 验证中进行 3 分钟时间盒循环转录，无 crash、无 hang（见 `docs/verification-v0.1.md`）

### 4.2 隐私与数据保留（冻结约束）

- 默认不上传音频。
- 默认不保存音频。
- 仅在用户启用 LLM 改写时上传文本到 API。
- 历史记录默认保存文本与元信息（可在设置中清空）。

### 4.3 密钥与敏感信息（冻结约束）

- LLM API Key 必须使用 Windows 安全存储优先（详见 `docs/tech-spec-v0.1.md`）。
- 日志中不得出现 API Key。
- 日志中不得出现完整的音频内容；若需要记录路径必须做脱敏或只记录 hash。

### 4.4 可观测性（冻结约束）

- 每次任务需要生成一个任务 ID。
- 每个阶段记录开始/结束时间、耗时与结果（成功/失败/取消）。
- 必须能在 UI 查看最近一次任务的详细错误信息与诊断提示。

## 5. 性能要求（Performance）

目标硬件：开发/验收机为具备 RTX 4060 Laptop GPU 的 Windows 环境（用户当前环境）。

说明：性能指标分为“本地部分”和“网络部分”。本地部分指 FFmpeg 预处理 + ASR 转录。LLM 改写耗时受网络影响，需要单独统计展示，不计入本地性能是否达标的判定。

### 5.1 交互延迟（MVP 验收）

- 点击开始录音到实际开始采集：<= 200ms
- 点击结束录音到进入“处理中”状态：<= 200ms
- 取消响应：<= 300ms（用户触发取消后，UI 显示取消成功，并停止后端计算）

### 5.2 本地转录速度（MVP 验收）

指标口径：RTF = ASR 转录耗时 / 音频时长（不含 LLM 网络耗时）。

- 必须达标
- 60 秒音频：RTF <= 0.30
- 5 分钟音频：RTF <= 0.35
- 目标（尽量达成）
- 60 秒音频：RTF <= 0.20
- 5 分钟音频：RTF <= 0.25

若未达标，必须在进入后续功能开发前完成性能优化（见 `docs/perf-spike-plan-v0.1.md`）。

### 5.3 资源占用与泄漏（MVP 验收）

- `full` 验证的 3 分钟时间盒运行中，无 crash、无 hang，且常驻内存无明显线性增长趋势（人工观察即可）。
- 必须使用 GPU 推理；若 GPU 不可用则任务失败，不允许降级到 CPU。

## 6. 分发与安装（Distribution）

### 6.1 冻结决策

- 允许安装包额外安装 VC++ Runtime 和 CUDA 相关依赖。
- 内置 FFmpeg 随包分发，并由应用内部调用。

### 6.2 发布合规（必须）

- 随包包含第三方许可证与声明文件（FFmpeg、模型、依赖库等）。
- 若内置 FFmpeg，必须在文档中明确 FFmpeg 版本、构建选项与许可证信息（详见技术规格）。

## 7. 验收标准（Checklist）

### 7.1 功能验收（必须全通过）

- 能录音、结束、取消。
- 能完成 FFmpeg 预处理并进入 ASR 转录。
- 能完成本地 ASR 转录并输出文本。
- 启用 LLM 时能完成改写并输出最终文本。
- LLM 失败时仍能输出 ASR 原文且可复制。
- 模板可在 UI 修改并立即生效。
- 历史记录仅保存文本，不保存音频。
- 一键复制工作正常。

### 7.2 稳定性验收（必须）

- `full` 验证的 3 分钟时间盒运行无崩溃、无卡死。
- 任意阶段取消均生效并释放资源。

### 7.3 性能验收（必须）

- 本地 RTF 达到 5.2 “必须达标”。
- UI 在处理中保持响应。

## 8. 待确认/待验证（不冻结）

- 模型下载源与镜像策略（HuggingFace 直连、镜像、或自建下载源）。
- 模型版本升级策略（是否支持多版本共存与回滚）。
- 默认 FFmpeg 参数是否需要做噪声处理或仅做格式统一。
